---
title: "Modele Nieparametryczne"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    theme: "flatly"
    code_folding: hide
---

```{r setup, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Inicjalizacja bibliotek

library(rpart)
library(rpart.plot)
library(VIM)
library("dplyr")
library("tidyr")
library("lubridate")
library("ggplot2")
library(DAAG)
library(party)
library(rpart)
library(rpart.plot)
library(mlbench)
library(caret)
library(pROC)
library(tree)
library(earth)
library(plotmo)
library(Metrics)



# Ładowanie danych

load(file="dane_zaliczenie.RData")


```

# Imputacja browser - Uczący
```{r}
# proba_uczaca$initialtransaction_id[is.na(proba_uczaca$initialtransaction_id)] <- proba_uczaca$id[is.na(proba_uczaca$initialtransaction_id)]
#  
#  for (i in 1:nrow(proba_uczaca)){
#    if (is.na(proba_uczaca[i,]$browseragent) == TRUE){
#      proba_uczaca[i,]$browseragent <- proba_uczaca[which(proba_uczaca$id == proba_uczaca[i,]$initialtransaction_id),]$browseragent
#    }
#  }
#  
# 
#  temp <- proba_uczaca[proba_uczaca$browseragent=="Fotka-android",]
#  proba_uczaca <- proba_uczaca[!(proba_uczaca$browseragent=="Fotka-android"),]
#  browser <- proba_uczaca$browseragent
#  browser_sub <- strsplit(browser,"[(]")
#  browser_sub <- sapply(browser_sub,'[[',2)
#  browser_sub <- strsplit(browser_sub,"[;]")
#  browser_sub <-sapply(browser_sub,'[[',1)
#  proba_uczaca$browseragent <- browser_sub
#  
#  proba_uczaca <- rbind(proba_uczaca, temp)
#  table(proba_uczaca$browseragent)

 # saveRDS(proba_uczaca, file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/proba_uczaca.rda")

proba_uczaca = readRDS(file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/proba_uczaca.rda")
```

# Imputacja browser - Testowy
```{r}
# proba_testowa$initialtransaction_id[is.na(proba_testowa$initialtransaction_id)] <- proba_testowa$id[is.na(proba_testowa$initialtransaction_id)]
#  
#  for (i in 1:nrow(proba_testowa)){
#    if (is.na(proba_testowa[i,]$browseragent) == TRUE){
#      proba_testowa[i,]$browseragent <- proba_testowa[which(proba_testowa$id == proba_testowa[i,]$initialtransaction_id),]$browseragent
#    }
#  }
#  
# 
#  temp <- proba_testowa[proba_testowa$browseragent=="Fotka-android",]
#  proba_testowa <- proba_testowa[!(proba_testowa$browseragent=="Fotka-android"),]
#  browser <- proba_testowa$browseragent
#  browser_sub <- strsplit(browser,"[(]")
#  browser_sub <- sapply(browser_sub,'[[',2)
#  browser_sub <- strsplit(browser_sub,"[;]")
#  browser_sub <-sapply(browser_sub,'[[',1)
#  proba_testowa$browseragent <- browser_sub
#  
#  proba_testowa <- rbind(proba_testowa, temp)
#  table(proba_testowa$browseragent)
# 
# saveRDS(proba_testowa, file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/proba_testowa.rda")

 proba_testowa = readRDS(file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/proba_testowa.rda")
```

## Tworzenie nowych zmiennych - Próba Ucząca
```{r}
proba_uczaca$day_of_week_createtime <- weekdays(proba_uczaca$createtime, abbreviate = FALSE)
proba_uczaca$month_createtime <- months(proba_uczaca$createtime, abbreviate = FALSE)
proba_uczaca$year_createtime <- year(proba_uczaca$createtime)
proba_uczaca$time_to_expire <-paste0(as.character(proba_uczaca$expiryyear),"-",as.character(proba_uczaca$expirymonth),"-", '01')
proba_uczaca$time_to_expire_result <- round(as.integer(difftime(proba_uczaca$time_to_expire,proba_uczaca$createtime,units = "weeks")))

```
## Tworzenie nowych zmiennych - Próba Testowa
```{r}
proba_testowa$day_of_week_createtime <- weekdays(proba_testowa$createtime, abbreviate = FALSE)
proba_testowa$month_createtime <- months(proba_testowa$createtime, abbreviate = FALSE)
proba_testowa$year_createtime <- year(proba_testowa$createtime)
proba_testowa$time_to_expire <-paste0(as.character(proba_testowa$expiryyear),"-",as.character(proba_testowa$expirymonth),"-", '01')
proba_testowa$time_to_expire_result <- round(as.integer(difftime(proba_testowa$time_to_expire,proba_testowa$createtime,units = "weeks")))

```
## Surowy zbiór danych
```{r data_presetation}
create_plot <- function(variable) {
  ggplot(proba_uczaca , aes(x=factor(variable), fill=factor(variable))) +
    geom_bar() +
    theme(legend.position="none",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

}
create_plot(proba_uczaca$expiryyear)
table(proba_uczaca$expiryyear)

create_plot(proba_uczaca$issuer)
table(proba_uczaca$issuer)

create_plot(proba_uczaca$mccname)
table(proba_uczaca$mccname)

create_plot(proba_uczaca$recurringaction)
table(proba_uczaca$recurringaction)

create_plot(proba_uczaca$type)
table(proba_uczaca$type)

create_plot(proba_uczaca$description)
table(proba_uczaca$description)

create_plot(proba_uczaca$level)
table(proba_uczaca$level)

create_plot(proba_uczaca$status)
table(proba_uczaca$status)

create_plot(proba_uczaca$countrycode)
table(proba_uczaca$countrycode)

create_plot(proba_uczaca$expirymonth)
table(proba_uczaca$expirymonth)

create_plot(proba_uczaca$listtype)
table(proba_uczaca$listtype)

create_plot(proba_uczaca$acquirerconnectionmethod)
table(proba_uczaca$acquirerconnectionmethod)

create_plot(proba_uczaca$browseragent)
table(proba_uczaca$browseragent)

create_plot(proba_uczaca$day_of_week_createtime)
table(proba_uczaca$day_of_week_createtime)

create_plot(proba_uczaca$month_createtime)
table(proba_uczaca$month_createtime)


create_plot(proba_uczaca$year_createtime)
table(proba_uczaca$year_createtime)


ggplot(proba_uczaca, aes(x=amount)) +
 geom_histogram(color="white", fill="darkgrey")


```
```{r}
mean = mean(proba_uczaca$amount)
std = sd(proba_uczaca$amount)

# wykorzystanie regu?y 3 odchyle?
Tmin = mean-(3*std)
Tmax = mean+(3*std)

summary(proba_uczaca$amount)
proba_uczaca <- filter(proba_uczaca,(amount > Tmin & amount < Tmax))

# Około 500 usuniętych rekordów
```


# Recode Uczący
```{r recode_uczacy, echo=FALSE}

proba_uczaca <- proba_uczaca[!(proba_uczaca$level=="CLASSIC/GOLD" | proba_uczaca$level=="GOLD/PLATINUM" | proba_uczaca$level=="GOLD/STANDARD" | proba_uczaca$level=="INFINITE/SIGNATURE" | proba_uczaca$level=="STANDARD/GOLD") | proba_uczaca$level=="STANDARD/WORLD",]
# Powtórzenie czynności - r niestety nie jest w stanie wykonać powyższego polecenia w pełni
proba_uczaca <- proba_uczaca[!(proba_uczaca$level=="STANDARD/WORLD"),]


proba_uczaca$description[is.na(proba_uczaca$description)] <- ""

proba_uczaca$description <- recode(proba_uczaca$description,
                              # Telekomunikacja
                              
                             "platnosci za faktury za tv internet telefon"="Telekomunikacja",
                             "Orange Flex:"="Telekomunikacja",
                             "Orange On-line:"="Telekomunikacja",
                             "PLAY - FAKTURA"="Telekomunikacja",
                             "PLAY - faktura"="Telekomunikacja",
                             "PLAY - weryfikacja"="Telekomunikacja",
                             "RedBull Mobile - FAKTURA"="Telekomunikacja",
                             "RedBull Mobile - faktura"="Telekomunikacja",
                             "RedBull Mobile - weryfikacja"="Telekomunikacja",
                             # Transport
                            
                             "iTaxi"="Transport",
                             "Przejazd A4Go"="Transport",
                             # Inne
                             .default = "inne")


proba_uczaca$browseragent <- recode(proba_uczaca$browseragent,
                             "Android 10"="Android",
                             "Android 11"="Android",
                             "Android 8.1.0"="Android",
                             "Fotka-android"="Android",
                             "Linux"="Linux",
                             "iPad"="iOS",
                             "iPhone"="iOS",
                             "Macintosh"="MacOS",
                             "PlayStation 4 7.51) AppleWebKit/605.1.15"="PS4",
                             "SMART-TV"="Smart-tv",
                             .default = "Windows")
table(proba_uczaca$browseragent)
proba_uczaca$countrycode <- recode(proba_uczaca$countrycode, "PL"="PL", .default = "other")

proba_uczaca$status <- recode(proba_uczaca$status, "completed successfully"="sukces", .default = "porażka")

proba_uczaca$issuer <- recode(proba_uczaca$issuer, "VISA"="VISA", .default = "MASTERCARD")

proba_uczaca$mccname <- recode(proba_uczaca$mccname, "NULL"="Inne",
                               "Usługi biznesowe gdzie indziej nie sklasyfikowane" = "Inne",
                               "Sklepy spożywcze różne"="Sklepy",
                               "Sklepy kosmetyczne"="Sklepy",
                               "Sieci komputerowe usługi informacyjne"="IT",
                               )

proba_uczaca$recurringaction <- recode(proba_uczaca$recurringaction, "AUTO"="rekurencyjne", .default = "inicjalizujące")



# Usunięcie tranzakcji inicjalizujących z bazy
proba_uczaca <- proba_uczaca[!(proba_uczaca$recurringaction=="inicjalizujące"),]
table(proba_uczaca$level)
proba_uczaca$level <- recode(proba_uczaca$level,
                             "WORLD"="WORLD","WORLD BLACK"="WORLD", "WORLD ELITE"="WORLD","WORLD BLACK EDITION"="WORLD","NEW WORLD"="WORLD",
                             "STANDARD"="STANDARD","STANDARD UNEMBOSSED"="STANDARD","CLASSIC"="STANDARD"," ELECTRON"="STANDARD",
                             "GOLD"="GOLD",
                             "PREPAID"="PREPAID","PREPAID PLATINUM"="PREPAID","PREPAID RELOADABLE"="PREPAID",
                             "BUSINESS"="BUSINESS","CORPORATE T&E"="BUSINESS",
                             .default = "other")

table(proba_uczaca$level)

proba_uczaca$day_of_week_createtime <- recode(proba_uczaca$day_of_week_createtime,
                                              "poniedziałek" = "poniedziałek", "wtorek" = "wtorek",
                                              "środa" = "środa", "czwartek" = "czwartek",
                                              "piątek" = "piątek", .default = "weekend")

proba_uczaca$month_createtime <- recode(proba_uczaca$month_createtime,
                                              "styczeń" = "I kwartał", "luty" = "I kwartał",
                                              "marzec" = "I kwartał", "kwiecień" = "II kwartał",
                                              "maj" = "II kwartał","czerwiec" = "II kwartał","lipiec" = "III kwartał","sierpień" = "III kwartał","wrzesień" = "III kwartał", .default = "IV kwartał")

proba_uczaca$status = relevel(proba_uczaca$status,ref = "sukces")

## Usuwanie zmiennych

proba_uczaca <- proba_uczaca %>% select(-c(screenheight, screenwidth,payclickedtime,id,initialtransaction_id,expirymonth,expiryyear,time_to_expire,createtime,recurringaction))
 

```
# Recode Testowy
```{r recode_testowy, echo=FALSE}
proba_testowa <- proba_testowa[!(proba_testowa$level=="CLASSIC/GOLD" | proba_testowa$level=="GOLD/PLATINUM" | proba_testowa$level=="GOLD/STANDARD" | proba_testowa$level=="INFINITE/SIGNATURE" | proba_testowa$level=="STANDARD/GOLD") | proba_testowa$level=="STANDARD/WORLD",]
# Powtórzenie czynności - r niestety nie jest w stanie wykonać powyższego polecenia w pełni
proba_testowa <- proba_testowa[!(proba_testowa$level=="STANDARD/WORLD"),]



proba_testowa$description[is.na(proba_testowa$description)] <- ""

proba_testowa$description <- recode(proba_testowa$description,
                              # Telekomunikacja
                              
                             "platnosci za faktury za tv internet telefon"="Telekomunikacja",
                             "Orange Flex:"="Telekomunikacja",
                             "Orange On-line:"="Telekomunikacja",
                             "PLAY - FAKTURA"="Telekomunikacja",
                             "PLAY - faktura"="Telekomunikacja",
                             "PLAY - weryfikacja"="Telekomunikacja",
                             "RedBull Mobile - FAKTURA"="Telekomunikacja",
                             "RedBull Mobile - faktura"="Telekomunikacja",
                             "RedBull Mobile - weryfikacja"="Telekomunikacja",
                             # Transport
                            
                             "iTaxi"="Transport",
                             "Przejazd A4Go"="Transport",
                             # Inne
                             .default = "inne")


proba_testowa$browseragent <- recode(proba_testowa$browseragent,
                             "Android 10"="Android",
                             "Android 11"="Android",
                             "Android 8.1.0"="Android",
                             "Fotka-android"="Android",
                             "Linux"="Linux",
                             "iPad"="iOS",
                             "iPhone"="iOS",
                             "Macintosh"="MacOS",
                             "PlayStation 4 7.51) AppleWebKit/605.1.15"="PS4",
                             "SMART-TV"="Smart-tv",
                             .default = "Windows")
table(proba_testowa$browseragent)
proba_testowa$countrycode <- recode(proba_testowa$countrycode, "PL"="PL", .default = "other")

proba_testowa$issuer <- recode(proba_testowa$issuer, "VISA"="VISA", .default = "MASTERCARD")

proba_testowa$mccname <- recode(proba_testowa$mccname, "NULL"="Inne",
                               "Usługi biznesowe gdzie indziej nie sklasyfikowane" = "Inne",
                               "Sklepy spożywcze różne"="Sklepy",
                               "Sklepy kosmetyczne"="Sklepy",
                               "Sieci komputerowe usługi informacyjne"="IT",
                               )

proba_testowa$recurringaction <- recode(proba_testowa$recurringaction, "AUTO"="rekurencyjne", .default = "inicjalizujące")



# Usunięcie tranzakcji inicjalizujących z bazy
proba_testowa <- proba_testowa[!(proba_testowa$recurringaction=="inicjalizujące"),]
table(proba_testowa$level)
proba_testowa$level <- recode(proba_testowa$level,
                             "WORLD"="WORLD","WORLD BLACK"="WORLD", "WORLD ELITE"="WORLD","WORLD BLACK EDITION"="WORLD","NEW WORLD"="WORLD",
                             "STANDARD"="STANDARD","STANDARD UNEMBOSSED"="STANDARD","CLASSIC"="STANDARD"," ELECTRON"="STANDARD",
                             "GOLD"="GOLD",
                             "PREPAID"="PREPAID","PREPAID PLATINUM"="PREPAID","PREPAID RELOADABLE"="PREPAID",
                             "BUSINESS"="BUSINESS","CORPORATE T&E"="BUSINESS",
                             .default = "other")

table(proba_testowa$level)

proba_testowa$day_of_week_createtime <- recode(proba_testowa$day_of_week_createtime,
                                              "poniedziałek" = "poniedziałek", "wtorek" = "wtorek",
                                              "środa" = "środa", "czwartek" = "czwartek",
                                              "piątek" = "piątek", .default = "weekend")

proba_testowa$month_createtime <- recode(proba_testowa$month_createtime,
                                              "styczeń" = "I kwartał", "luty" = "I kwartał",
                                              "marzec" = "I kwartał", "kwiecień" = "II kwartał",
                                              "maj" = "II kwartał","czerwiec" = "II kwartał","lipiec" = "III kwartał","sierpień" = "III kwartał","wrzesień" = "III kwartał", .default = "IV kwartał")


## Usuwanie zmiennych

proba_testowa <- proba_testowa %>% select(-c(screenheight, screenwidth,payclickedtime,id,initialtransaction_id,expirymonth,expiryyear,time_to_expire,createtime,recurringaction))


```

## Przedstawienie brakujących danych

```{r}
missing_data_plot <- aggr(proba_uczaca, col=c('forestgreen','firebrick1'),
                          numbers=TRUE, sortVars=TRUE,
                          labels=names(proba_uczaca), cex.axis=.7,
                          gap=3, ylab=c("Missing data","Pattern"))

```

## Zbiór danych po grupowaniu zmiennych
```{r data_presetation}
# create_plot <- function(variable) {
#   ggplot(proba_uczaca , aes(x=factor(variable), fill=factor(variable))) +
#     geom_bar() +
#     theme(legend.position="none",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
#
# }
#
#
# create_plot(proba_uczaca$issuer)
# table(proba_uczaca$issuer)
#
# create_plot(proba_uczaca$mccname)
# table(proba_uczaca$mccname)
#
# create_plot(proba_uczaca$recurringaction)
# table(proba_uczaca$recurringaction)
#
# create_plot(proba_uczaca$type)
# table(proba_uczaca$type)
#
# create_plot(proba_uczaca$description)
# table(proba_uczaca$description)
#
# create_plot(proba_uczaca$level)
# table(proba_uczaca$level)
#
# create_plot(proba_uczaca$status)
# table(proba_uczaca$status)
#
# #create_plot(proba_uczaca$countrycode)
# #table(proba_uczaca$countrycode)
#
# create_plot(proba_uczaca$listtype)
# table(proba_uczaca$listtype)
#
# create_plot(proba_uczaca$acquirerconnectionmethod)
# table(proba_uczaca$acquirerconnectionmethod)
#
# create_plot(proba_uczaca$day_of_week_createtime)
# table(proba_uczaca$day_of_week_createtime)
#
# create_plot(proba_uczaca$month_createtime)
# table(proba_uczaca$month_createtime)
#
# create_plot(proba_uczaca$expirydate)
# table(proba_uczaca$expirydate)
#
# create_plot(proba_uczaca$year_createtime)
# table(proba_uczaca$year_createtime)

```



```{r}
set.seed(2137)

proba_uczaca$id <- 1:nrow(proba_uczaca)
ucz <- proba_uczaca %>% dplyr::sample_frac(0.7)
wal <- dplyr::anti_join(proba_uczaca, ucz, by = 'id')

proba_uczaca <- ucz
proba_walidacyjna <- wal

rm(wal)
rm(ucz)
proba_uczaca <- proba_uczaca %>% select(-c(id))
proba_walidacyjna <- proba_walidacyjna %>% select(-c(id))

```





# Proste drzewo
```{r}
# Model Prostego drzewo

drzewo <- rpart(
  formula = status ~ .,
  data = proba_uczaca,
)
# wykres prostego drzewa

rpart.plot(x= drzewo,
           box.palette = "GnBu",
           branch.lty = 3,
           shadow.col = "gray",
            nn = TRUE,
           extra = 104
                      )

# Podsumowanie drzewa
rpart.rules(
  x = drzewo,
  style = "tallw"
)
summary(drzewo)

# Przewidywanie
predicted_simple <- predict(drzewo, proba_testowa, type = "class")

confusionMatrix(predicted_simple, proba_walidacyjna$status, positive = "sukces")
```
# Drzewo przeuczone

```{r}
# Model drzewa

drzewo.duze <- rpart(
  formula = status ~ .,
  data = proba_uczaca,
  control = rpart.control(cp=0)
)

# Wykres Drzewa
# 
# rpart.plot(x= drzewo.duze,
#            box.palette = "GnBu",
#            branch.lty = 3,
#            shadow.col = "gray",
#             nn = TRUE,
#            extra = 104)

# Przewidywanie
predicted_Overfitting  = predict(drzewo.duze, proba_walidacyjna, type = "class")
confusionMatrix(predicted_Overfitting, proba_walidacyjna$status, positive = "sukces")

```

# Drzewo przycięte
```{r}

# Model drzewo przycięte 
bledy <- drzewo.duze$cptable

nr.min.cp <- which.min(bledy[, "xerror"])  # numer min cp w sprawdzaniu krzyżowym
tmp2 <- sum(bledy[nr.min.cp, c("xerror", "xstd")]) # min błąd + odchylenie standardowe
optymalny <- which(bledy[, "xerror"] < tmp2)[1] # nr optymalnego drzewa

drzewo.przyciete <- prune(drzewo.duze, cp = bledy[optymalny, "CP"])

#Wykres drzewa
rpart.plot(x= drzewo.przyciete,
           box.palette = "GnBu",
           branch.lty = 3,
           shadow.col = "gray",
            nn = TRUE,
           extra = 104)


# Przewidywanie
predicted_prune  = predict(drzewo.przyciete, proba_walidacyjna, type = "class")
confusionMatrix(predicted_prune, proba_walidacyjna$status, positive = "sukces")
cbind(drzewo.przyciete$variable.importance)

```

## MARS
```{r}
# Model MARS dla amount
sum(is.na(proba_uczaca))

mars1 <- earth(amount ~ .,
               data = proba_uczaca)
summary(mars1)

```

```{r}
X <- mars1$bx # macierz faktycznych predyktorów (w finalnym modelu)

punkty <- mars1$cuts

mars1$selected.terms
przycinanie <- mars1$prune.terms

plot(mars1$rss.per.subset)
plot(mars1$gcv.per.subset)

# Zbudować model MARS pozwalając na interakcje



mars2 <- earth(formula = amount ~ .,
               data = proba_uczaca,
      degree = 3,
      trace = 3
      ) # drukuje szczegóły przebiegu fazy I i II
summary(mars2)
# Ustalić optymalne wartości parametrów ('nk', 'minspan', 'thresh')
        # 'nk' - max liczba funkcji bazowych w pierwszej fazie
        # 'minspan' - min liczba obserwacji pomiędzy węzłami (dla minspan=1 węzły dla każdej obserwacji)
        # 'thresh' - min zwiększenie R2

# gcv.nk <- sapply(seq(5, 80, 5), function(x)
#         earth(formula = amount ~ .,
#                data = proba_uczaca,
#               degree = 3,
#               nk = x,
#               trace = 3
#               )$gcv) #gcv 80



mars3 <- earth(formula = amount ~ .,
               data = proba_uczaca,
               degree = 3,
               trace=3,
               nk = 80)
summary(mars3)
# 
# gcv.thresh <- sapply(0.1^(3:5), function(x)
#         earth(formula = amount ~ .,
#                data = proba_uczaca,
#               degree = 3,
#               nk = 200,
#               trace = 3,
#               thresh = x)$gcv)  # thresh = 0.0001
# 
# gcv.minspan <- sapply(1:10, function(x)
#         earth(formula = amount ~ .,
#                data = proba_uczaca,
#               degree = 3,
#               nk = 160,
#               trace = 3,
#               thresh = 0.0001,
#               minspan = x)$gcv) # minspan = 2
# 
# 
# gcv.nk <- sapply(seq(80, 200, 5), function(x)
#         earth(formula = amount ~ .,
#                data = proba_uczaca,
#                degree = 3,
#                nk = x,
#                thresh = 0.0001,
#                trace = 3,
#                minspan = 2
#               )$gcv) #gcv 150

mars4 <- earth(formula = amount ~ .,
               data = proba_uczaca,
               degree = 3,
               nk = 150,
               thresh = 0.0001,
               trace = 3,
               minspan = 2)


summary(mars4)

# Sporządzić wykres diagnostyczny modelu
plot(mars4, info = T)

# Sprawdzić jaka byłaby optymalna liczba składników (terms) na podstawie sprawdzania krzyżowego
mars5 <- earth(formula = amount ~ .,
               data = proba_uczaca,
               degree = 3,
               nk = 150,
               thresh = 0.0001,
               minspan = 2,
               trace = 3,
               pmethod = "cv", # sprawdzanie krzyżowe
               nfold = 10,  # liczba części w sprawdzaniu krzyżowym
               ncross = 1, # ile razy wykonać cv (większa wartość = stabilniejsze wyniki)
               keepxy = T) # zachowanie danych x i y, żeby na wykresach diagnostycznych było cv
# terms 23

plot(mars5, which = 1)

summary(mars5)

# Sporządzić wykres przedstawiający wpływ poszczególnych zmiennych niezależnych na zmienną zależną
plotmo(mars1)
plotmo(mars2)
plotmo(mars3)
plotmo(mars4)
plotmo(mars5)


plotmo(mars1, 
       degree1 = "listtype", 
       pt.col = "grey",  # kolor punktu
       jitter = 0,       # bez "potrząsania" danymi
       ylim = c(5, 25),
       xlim = c(0, 200),
       grid.col = T,     # linie siatki
       npoints = T)      # wszystkie punkty

plotmo(mars4,
       degree2 = c("metraz", "l_pieter"),
       degree1 = F)

# Oszacować ważność zmiennych objaśniających
evimp(mars4)  # jest to ważność w modelu (nie ważność w ogóle dla tego problemu regresji)


```
# Testy predykcji
```{r}
mars2

pred = predict(mars4,proba_testowa)
actual = proba_testowa$amount
cbind(pred,actual)
mse(actual,pred)^0.5
table(proba_testowa$mccname)
table(proba_uczaca$mccname)
# Drugi jest najlepszy
```

#Saving Models
```{r}
 # saveRDS(mars1, file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/mars1.rda")
 # saveRDS(mars2, file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/mars2.rda")
 # saveRDS(mars3, file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/mars3.rda")
 # saveRDS(mars4, file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/mars4.rda")
 # saveRDS(mars5, file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/mars5.rda")
```

#Loading Models
```{r}
mars1 = readRDS(file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/mars1.rda")
mars2 = readRDS(file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/mars2.rda")
mars3  = readRDS(file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/mars3.rda")
mars4 = readRDS(file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/mars4.rda")
mars5 = readRDS(file = "C:/Users/modze/Desktop/UG semsetr2/Modele nieparametrycze/Mars/Modele/mars5.rda")
```


